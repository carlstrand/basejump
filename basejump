#!/bin/bash

set -e

echo "=> Ohai! Let's basejump!"

software-check(){
  echo "=> Checking for required software..."
    for cli in git rsync zsh vim; do
      if ! type "$cli" > /dev/null 2>&1; then
        "NOTICE $cli is not installed - install that and try again"; exit 1
      fi
  	done
}

install-dots(){
  echo "=> Installing dotfiles..."
  git clone https://github.com/philcryer/dotty.git
  cd dotty
  rsync --exclude ".git/" --exclude ".ssh" --exclude "README.md" --exclude "LICENSE" -avh --no-perms . ~;
cd -
  if [ ! -d '~/.ssh' ]; then
	mkdir -p ~/.ssh
  fi
  mv $HOME/.sshconfig $HOME/.ssh/config-sample
  rm -rf dotty
  echo "=> Creating .vim dirs, if needed..."
	if [ ! -d '~/.vim/backups' ]; then
		mkdir -p ~/.vim/backups
	fi
	if [ ! -d '~/.vim/swaps' ]; then
		mkdir -p ~/.vim/swaps
	fi
	if [ ! -d '~/.vim/undo' ]; then
		mkdir -p ~/.vim/undo
	fi
}

install-prezto(){
	cd ~
	if [ ! -d '.zprezto' ]; then
  echo "=> Installing zprezto..."
	git clone --recursive https://github.com/sorin-ionescu/prezto.git ".zprezto"
	ln -s .zprezto/runcoms/zlogin .zlogin
	ln -s .zprezto/runcoms/zlogout .zlogout
	ln -s .zprezto/runcoms/zpreztorc .zpreztorc
	ln -s .zprezto/runcoms/zshenv .zshenv
    mv .prompt_fak3r_setup ~/.zpvrezto/modules/prompt/functions/prompt_fak3r_setup
	sed -i 's/sorin/fak3r/g' ~/.zpreztorc  
if [ -f .zshrc ]; then
	rm -f .zshrc
fi
	ln -s .zprezto/runcoms/zshrc .zshrc
    cd -; cat .zshrc.history >> ${HOME}/.zshrc
	fi
}

install-amix-vimrc(){
    echo "=> Installing amix/vimrc..."
    git clone https://github.com/amix/vimrc.git ~/.vim_runtime
    sh ~/.vim_runtime/install_awesome_vimrc.sh
}

if [ "$1" == "--update" -o "$1" == "-u" ]; then
  echo "=> Updating existing install..."
	install-dots;
	if [ ! -d '~/.zprezto' ]; then
		cd ~/.zprezto
		git pull
		exit 0
	fi
fi

if [ "$1" == "--force" -o "$1" == "-f" ]; then
  echo "=> Installing without prompts, like a boss..."
  software-check;
  install-dots;
  install-prezto;
  install-amix-vimrc;
else
  read -p "=> This may overwrite existing files! Are you sure? (y/n) " -n 1;
  echo "";
    if [[ $REPLY =~ ^[Yy]$ ]]; then
      software-check;
      install-dots;
      install-prezto;
      install-amix-vimrc;
    fi;
fi;

if [ ! -f '~/.extra' ]; then
	touch ~/.extra
	echo "NOTICE: edit the ~/.extra file if you want to override any functionality"
else 
	echo "NOTICE: edit the ~/.extra file if you want to override any functionality"
fi

echo;echo "NOTICE: attempting to change your default shell (provide password)"
echo "NOTICE: if this step fails just run 'chsh -s /bin/zsh', logout and back in."
chsh -s /bin/zsh
echo "NOTICE: exit shell and re-login changes to be applied"

exit 0
