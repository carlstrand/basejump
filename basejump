#!/bin/bash

set -e

function software-check(){
  echo "=> Checking for required software..."
    for cli in git rsync zsh; do
      if ! type "$cli" > /dev/null 2>&1; then
        "NOTICE $cli is not installed - trying to install"
	 sudo apt-get install $cli
      fi
  done
  echo "=> Checing for required packages..."
#    if [ ! -d '/usr/share/doc/vim-nox' ]; then
#      sudo apt-get install vim-nox
#    fi
}

function install-dots(){
  git clone https://github.com/philcryer/dotty.git
  cd dotty
  rsync --exclude ".git/" --exclude ".ssh" --exclude "README.md" --exclude "LICENSE" -avh --no-perms . ~;
cd -
  rm -rf dotty
}

function install-prezto(){
	cd ~
	if [ ! -d '.zprezto' ]; then
	git clone --recursive https://github.com/sorin-ionescu/prezto.git ".zprezto"
	ln -s .zprezto/runcoms/zlogin .zlogin
	ln -s .zprezto/runcoms/zlogout .zlogout
	ln -s .zprezto/runcoms/zpreztorc .zpreztorc
	ln -s .zprezto/runcoms/zprofile .zprofile
	ln -s .zprezto/runcoms/zshenv .zshenv
if [ -f .zshrc ]; then
	rm -f .zshrc
fi
	ln -s .zprezto/runcoms/zshrc .zshrc
	fi
}

if [ "$1" == "--force" -o "$1" == "-f" ]; then
  software-check;
  install-dots;
else
  read -p "This may overwrite existing files in your home directory. Are you sure? (y/n) " -n 1;
  echo "";
    if [[ $REPLY =~ ^[Yy]$ ]]; then
      software-check;
      install-dots;
    fi;
fi;

if [ ! -d '~/.zprezto' ]; then
	install-prezto;

	echo;echo "NOTICE: attempting to change your default shell (provide password)"
	chsh -s /bin/zsh

	echo "NOTICE: exit shell and re-login changes to be applied"
fi
if [ -d '~/.extra' ]; then
	echo "NOTICE: edit ~/.extra for more functionality"
fi

exit 0
